{% extends "base.html" %}
{% load tz %}
{% block title %}Дефект{% endblock %}
{% block topbar %}{% endblock %}
{% block content %}
<style>
  .detail-wrap { max-width: 900px; margin: 24px 48px; background:#fff; border-radius:16px; box-shadow:0 10px 20px rgba(0,0,0,0.08); }
  .detail-head { display:flex; align-items:center; justify-content:space-between; padding:18px 20px; border-bottom:1px solid #f0f0f0; }
  .detail-title { margin:0; color:#ff8a2f; font-weight:700; }
  .detail-body { padding:18px 20px; }
  .info-table { width:100%; border-collapse:collapse; }
  .info-table th { width:180px; color:#555f6d; font-weight:600; padding:8px 0; }
  .info-table td { padding:8px 0; }
  .muted { color:#8a9096; }
  .actions { display:flex; gap:10px; }
  .action-btn { background-color: transparent; color: var(--c); height: 2.2em; border: 1px solid var(--c); border-radius: 10px; transition: all 0.4s ease; display:inline-flex; align-items:center; gap:8px; padding: 0 0.9em; text-decoration:none; }
  .action-btn:hover { background-color: var(--c); cursor: pointer; color:#fff; border-radius: 8px; }
  .action-btn .text { margin: 0; font-weight:500; }
  .action-orange { --c: #ff8a2f; }
  .action-gray { --c: #8a9096; }
</style>
<div class="detail-wrap">
  <div class="detail-head">
    <h3 class="detail-title">{{ defect.title }}</h3>
    <div class="actions">
      {% if user.is_authenticated %}
        {% if user.is_manager %}
          <a class="action-btn action-gray" href="/defects/{{ defect.id }}/edit/"><span class="text">Редактировать</span></a>
          <a class="action-btn action-orange" href="/defects/{{ defect.id }}/change_status/"><span class="text">Изменить статус</span></a>
          <a class="action-btn action-gray" href="/defects/{{ defect.id }}/assign/"><span class="text">Назначить инженера</span></a>
          <a class="action-btn action-gray" href="/defects/{{ defect.id }}/delete/"><span class="text">Удалить</span></a>
        {% elif user.is_engineer and defect.performer_id == user.id %}
          <a class="action-btn action-gray" href="/defects/{{ defect.id }}/edit/"><span class="text">Редактировать</span></a>
          <a class="action-btn action-orange" href="/defects/{{ defect.id }}/change_status/"><span class="text">Изменить статус</span></a>
        {% endif %}
        {% if not user.is_observer %}
          <a class="action-btn action-orange" href="/defects/{{ defect.id }}/attachments/"><span class="text">Вложения</span></a>
        {% endif %}
      {% endif %}
    </div>
  </div>
  <div class="detail-body">
    <table class="info-table">
      <tr><th>Проект</th><td>{{ defect.project.title }}</td></tr>
      <tr><th>Этап</th><td class="muted">{% if defect.stage %}{{ defect.stage.title }}{% endif %}</td></tr>
      <tr><th>Статус</th><td class="muted">{{ defect.get_status_display }}</td></tr>
      <tr><th>Приоритет</th><td class="muted">{{ defect.get_priority_display }}</td></tr>
      <tr><th>Исполнитель</th><td class="muted">{% if defect.performer %}{{ defect.performer.username }}{% endif %}</td></tr>
      <tr><th>Срок</th><td class="muted">{{ defect.deadline|default:"не задано" }}</td></tr>
      <tr><th>Описание</th><td class="muted">{{ defect.description }}</td></tr>
    </table>
    <h5 style="margin:16px 0 6px; color:#555f6d;">История статусов</h5>
    <ul style="list-style:none; padding:0; margin:0;">
      {% for h in defect.status_history.all %}
        <li style="padding:8px 0; border-bottom:1px solid #f0f0f0;">{{ h.changed_at|localtime }}: {{ h.old_status }} → {{ h.new_status }} {% if h.changed_by %}({{ h.changed_by.username }}){% endif %}</li>
      {% empty %}
        <li class="muted">Нет истории</li>
      {% endfor %}
    </ul>
    <h5 style="margin:16px 0 6px; color:#555f6d;">Комментарии</h5>
    <ul style="list-style:none; padding:0; margin:0;">
      {% for c in defect.comments.all %}
        <li style="padding:8px 0; border-bottom:1px solid #f0f0f0;">{{ c.created_at|localtime }} — {{ c.author.username }}: {{ c.text }}</li>
      {% empty %}
        <li class="muted">Нет комментариев</li>
      {% endfor %}
    </ul>
    {% if not user.is_observer %}
    <form method="post" class="mt-3">
      {% csrf_token %}
      {{ comment_form.as_p }}
      <button class="action-btn action-orange" type="submit"><span class="text">Добавить комментарий</span></button>
    </form>
    {% endif %}
    <h5 style="margin:16px 0 6px; color:#555f6d;">Вложения</h5>
    <div class="row">
      {% for a in defect.attachments.all %}
      <div class="col-md-4 mb-3">
        <div class="card">
          <img src="{{ a.file.url }}" class="card-img-top" onerror="this.style.display='none'">
          <div class="card-body"><a href="{{ a.file.url }}" target="_blank">Скачать</a></div>
        </div>
      </div>
      {% empty %}
      <p class="muted">Нет вложений</p>
      {% endfor %}
    </div>
  </div>
</div>
{% endblock %}