{% extends "base.html" %}
{% block title %}Дефекты{% endblock %}
{% block page_title %}Дефекты{% endblock %}
{% block topbar %}
<div class="topbar-wrap" style="max-width:900px; margin:0 24px 0 48px;">
  <div class="topbar">
    <div class="topbar-title">Дефекты</div>
    <div class="topbar-right"></div>
  </div>
</div>
{% endblock %}
{% block content %}
<style>
  .content-row { display:flex; align-items:flex-start; gap:24px; max-width:1200px; margin: 16px 24px 40px 48px; }
  .left-col { flex:1; }
  .time-side { width: 280px; }
  .card-list { max-width:900px; margin:24px 24px 40px 48px; background:#fff; border-radius:16px; box-shadow:0 10px 20px rgba(0,0,0,0.08); }
  .row-item { display:flex; align-items:center; justify-content:space-between; padding:16px 20px; border-bottom:1px solid #f0f0f0; }
  .row-item:last-child { border-bottom:none; }
  .muted { color:#8a9096; }
  .create-pill { display:inline-flex; align-items:center; gap:8px; border:1px solid #ff8a2f; color:#ff8a2f; border-radius:999px; padding:6px 10px; font-size:13px; font-weight:600; text-decoration:none; }
  .create-pill:hover { background:#ff8a2f; color:#fff; }
  .button { position:relative; background-color: transparent; color: #ff8a2f; height: 2.0em; border: 1px solid #ff8a2f; border-radius: 10px; transition: all 0.4s ease; display:inline-flex; align-items:center; justify-content:flex-end; padding: 0 1.0em; font-size:13px; }
  .button:hover { background-color: #ff8a2f; cursor: pointer; color:#fff; border-radius: 8px; }
  .button svg { width: 1.0em; position: absolute; right: 0.4em; transition: all 0.4s ease; fill: currentColor; }
  .button:hover svg { transform: translateX(3px); }
  .text { margin: 0 0.9em 0 0; font-weight:600; }
  .filters { display:flex; align-items:center; gap:12px; padding:12px 20px; border-bottom:1px solid #f0f0f0; flex-wrap:wrap; }
  .filters input, .filters select { border:1px solid #ddd; border-radius:10px; padding:8px 10px; }
  .filters input:focus, .filters select:focus { outline:none; border-color: rgba(247,127,0,0.55); box-shadow:0 0 0 4px rgba(247,127,0,0.14); }
  .dd { position:relative; }
  .dd-trigger { display:inline-flex; align-items:center; justify-content:center; height:40px; padding:0 14px; background:#f3f3f4; color:#555f6d; border:2px solid transparent; border-radius:8px; font-size:13px; transition:0.3s ease; }
  .dd-trigger:hover, .dd-trigger:focus { outline:none; border-color: rgba(247, 127, 0, 0.4); background:#fff; box-shadow:0 0 0 4px rgb(247 127 0 / 10%); }
  .dd-menu { position:absolute; top: calc(100% + 6px); left:0; min-width: 180px; background:#fff7f0; border:1px solid #ff8a2f; border-radius:10px; box-shadow:0 8px 16px rgba(0,0,0,0.08); padding:6px 0; display:none; z-index:10; }
  .dd-item { padding:8px 12px; color:#555f6d; cursor:pointer; }
  .dd-item + .dd-item { border-top:1px solid rgba(255,138,47,0.35); }
  .dd-item:hover { background:#ffead6; }
  .group { display:flex; line-height:28px; align-items:center; position:relative; max-width: 360px; flex: 0 0 360px; }
  .input { width:100%; height:40px; line-height:28px; padding:0 1rem; padding-right:2.5rem; border:2px solid transparent; border-radius:8px; outline:none; background-color:#f3f3f4; color:#0d0c22; transition:0.3s ease; font-size:13px; }
  .input::placeholder { color:#9e9ea7; }
  .input:focus, .input:hover { outline:none; border-color: rgba(247, 127, 0, 0.4); background-color:#fff; box-shadow:0 0 0 4px rgb(247 127 0 / 10%); }
  .icon { position:absolute; right:1rem; fill:#9e9ea7; width:1rem; height:1rem; opacity:0.7; transition:opacity .2s ease; pointer-events:none; }
  .input:not(:placeholder-shown) ~ .icon { opacity:0; }
  /* Time cloud */
  .card-time-cloud { position: relative; border-radius: 1em; width: 17.5em; height: 8em; z-index: 2; border: solid 0.15em var(--color1); transition: none; box-shadow: 0em 0em rgb(0, 0, 0, 0.25); overflow: hidden; --color1: rgb(237, 120, 42); --skycolor: #ffffff; }
  .card-time-cloud-front { width: 20em; height: 12.5em; background: rgb(228, 228, 228); border-radius: 1em; position: absolute; z-index: 2; top: 95%; left: 50%; transform: translate(-50%, -50%); transition: none; }
  .card-time-cloud-back { width: 20em; height: 17.5em; background: var(--skycolor); border-radius: 1em; position: absolute; z-index: 1; top: 57.5%; left: 50%; transform: translate(-50%, -50%); transition: none; }
  .card-time-cloud-back svg { position: absolute; z-index: 1; top: -16.45em; left: -7.5em; width: 25em; height: auto; opacity: 100%; animation: rotate-cloud 15s linear infinite; }
  .card-time-cloud-back svg:nth-child(2) { animation: rotate-cloud 15s linear infinite 1s; opacity: 50%; }
  @keyframes rotate-cloud { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  .card-time-cloud-day { color: var(--color1); position: absolute; z-index: 3; top: 1.25em; left: 0.5em; font-size: 1.5em; font-weight: bold; transition: none; }
  .card-time-cloud-day-number { color: var(--color1); position: absolute; z-index: 3; top: 3em; left: 0.65em; font-size: 1.25em; font-weight: 500; transition: none; }
  .card-time-cloud-hour { color: var(--color1); position: absolute; z-index: 3; top: 1.25em; right: 0.5em; font-size: 1.6em; font-weight: bold; transition: none; font-variant-numeric: tabular-nums; white-space: nowrap; }
  .card-time-cloud-icon svg { position: absolute; z-index: 4; top: 4em; right: 0.6em; transform: rotate(0deg); width: 1.5em; height: auto; }
  .recent-actions { margin-top:12px; }
  .recent-item { font-size:12px; color:#555f6d; padding:6px 8px; border-radius:8px; background:#fff; border-left:2px solid #ff8a2f; box-shadow:0 2px 6px rgba(0,0,0,0.06); margin-bottom:8px; }
  .recent-item .time { color:#ff8a2f; font-weight:600; margin-right:6px; }
  .recent-item.muted { color:#9ea5ac; background:#f7f7f7; border-left-color:#ddd; box-shadow:none; }
  .topbar-wrap { max-width: 900px; margin: 0 24px 0 48px; }
  .filters .export { margin-left:auto; display:flex; gap:8px; align-items:center; flex-wrap:nowrap; }
</style>
<div class="content-row">
  <div class="left-col">
    <div class="card-list">
      <div class="d-flex justify-content-between align-items-center" style="padding:16px 20px;">
        <h4 style="margin:0;">Дефекты</h4>
        {% if not user.is_observer %}
          <a class="create-pill" href="/defects/create/">Создать дефект</a>
        {% endif %}
      </div>
      <form method="get" class="filters">
        <div class="group">
          <input class="input" name="q" placeholder="Поиск дефекта" value="{{ request.GET.q }}">
          <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M10 18a8 8 0 1 1 0-16 8 8 0 0 1 0 16zm11 3-6-6" stroke="#9e9ea7" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
        </div>
        <div class="dd" data-name="status">
          <input type="hidden" name="status" value="{{ request.GET.status }}">
          <button type="button" class="dd-trigger">{% if request.GET.status == 'new' %}новый{% elif request.GET.status == 'in_progress' %}в работе{% elif request.GET.status == 'review' %}на проверке{% elif request.GET.status == 'closed' %}закрыт{% elif request.GET.status == 'cancelled' %}отменён{% else %}Статус{% endif %}</button>
          <div class="dd-menu">
            <div class="dd-item" data-val="">Статус</div>
            <div class="dd-item" data-val="new">новый</div>
            <div class="dd-item" data-val="in_progress">в работе</div>
            <div class="dd-item" data-val="review">на проверке</div>
            <div class="dd-item" data-val="closed">закрыт</div>
            <div class="dd-item" data-val="cancelled">отменён</div>
          </div>
        </div>
        <div class="dd" data-name="priority">
          <input type="hidden" name="priority" value="{{ request.GET.priority }}">
          <button type="button" class="dd-trigger">{% if request.GET.priority == 'low' %}низкий{% elif request.GET.priority == 'medium' %}средний{% elif request.GET.priority == 'high' %}высокий{% else %}Приоритет{% endif %}</button>
          <div class="dd-menu">
            <div class="dd-item" data-val="">Приоритет</div>
            <div class="dd-item" data-val="low">низкий</div>
            <div class="dd-item" data-val="medium">средний</div>
            <div class="dd-item" data-val="high">высокий</div>
          </div>
        </div>
        <div class="export">
          <a class="button" href="/defects/export/csv/?{{ request.GET.urlencode }}">Экспорт CSV</a>
          <a class="button" href="/defects/export/xls/?{{ request.GET.urlencode }}">Экспорт Excel</a>
        </div>
      </form>
      <script>
        (function(){
          var form = document.querySelector('.filters');
          document.querySelectorAll('.dd').forEach(function(dd){
            var btn = dd.querySelector('.dd-trigger');
            var menu = dd.querySelector('.dd-menu');
            var input = dd.querySelector('input[type="hidden"]');
            btn.addEventListener('click', function(){
              document.querySelectorAll('.dd .dd-menu').forEach(function(m){ if(m!==menu) m.style.display='none'; });
              menu.style.display = menu.style.display==='block' ? 'none' : 'block';
            });
            menu.querySelectorAll('.dd-item').forEach(function(item){
              item.addEventListener('click', function(){
                var val = this.getAttribute('data-val');
                input.value = val;
                btn.textContent = this.textContent;
                menu.style.display='none';
                form.submit();
              });
            });
          });
          document.addEventListener('click', function(e){
            if(!e.target.closest('.dd')){
              document.querySelectorAll('.dd .dd-menu').forEach(function(m){ m.style.display='none'; });
            }
          });
        })();
      </script>
      {% for d in defects %}
        <div class="row-item">
          <div>
            <div><strong style="color:#ff8a2f;">{{ d.title }}</strong></div>
            <div class="muted">Проект: {{ d.project.title }} • Статус: {{ d.get_status_display }} • Приоритет: {{ d.get_priority_display }} • Срок: {{ d.deadline|default:"не задано" }}</div>
          </div>
          <a class="button" href="/defects/{{ d.id }}/"><span class="text">Открыть</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M5 3l6 5-6 5V3z"/></svg></a>
        </div>
      {% empty %}
        <div class="row-item"><span class="muted">Нет дефектов</span></div>
      {% endfor %}
    </div>
  </div>
  <div class="time-side">
    <div class="card-time-cloud">
      <div class="card-time-cloud-back">
        <svg viewBox="0 0 64 32" xmlns="http://www.w3.org/2000/svg"><path fill="#f2f2f2" d="M12 20c-6 0-10-4-10-9s4-9 10-9c3 0 5 1 7 3 2-3 6-5 10-5 7 0 13 6 13 13 4 0 7 3 7 7s-3 7-7 7H12z"/></svg>
        <svg viewBox="0 0 64 32" xmlns="http://www.w3.org/2000/svg"><path fill="#e6e6e6" d="M16 22c-6 0-10-4-10-9s4-9 10-9c3 0 5 1 7 3 2-3 6-5 10-5 7 0 13 6 13 13 4 0 7 3 7 7s-3 7-7 7H16z"/></svg>
      </div>
      <div class="card-time-cloud-front"></div>
      <div id="cloud-day" class="card-time-cloud-day"></div>
      <div id="cloud-day-number" class="card-time-cloud-day-number"></div>
      <div id="cloud-hour" class="card-time-cloud-hour"></div>
      <div class="card-time-cloud-icon"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="3" fill="#ed782a"/><path d="M12 2v3M12 19v3M2 12h3M19 12h3M4.5 4.5l2.1 2.1M17.4 17.4l2.1 2.1M4.5 19.5l2.1-2.1M17.4 6.6l2.1-2.1" stroke="#ed782a" stroke-width="1.5"/></svg></div>
    </div>
    <div class="recent-actions">
      {% for a in recent_actions %}
        <div class="recent-item" data-ts="{{ a.ts }}"><span class="time">{{ a.time }}</span> — {{ a.text }}</div>
      {% empty %}
        <div class="recent-item muted">Нет недавних действий</div>
      {% endfor %}
    </div>
  </div>
</div>
<script>
  (function(){
    function updateTime(){
      var now = new Date();
      var days = ['Воскресенье','Понедельник','Вторник','Среда','Четверг','Пятница','Суббота'];
      var dayEl = document.getElementById('cloud-day');
      var dateEl = document.getElementById('cloud-day-number');
      var timeEl = document.getElementById('cloud-hour');
      if(dayEl) dayEl.textContent = days[now.getDay()];
      if(dateEl) dateEl.textContent = now.toLocaleDateString('ru-RU', { day:'2-digit', month:'long', year:'numeric' });
      if(timeEl) timeEl.textContent = now.toLocaleTimeString('ru-RU', { hour:'2-digit', minute:'2-digit' });
    }
    updateTime();
    setInterval(updateTime, 1000);
  })();
</script>
<script>
  (function(){
    function fmtHM(d){ return d.toLocaleTimeString('ru-RU', { hour:'2-digit', minute:'2-digit' }); }
    document.querySelectorAll('.recent-actions .recent-item').forEach(function(el){
      var ts = el.getAttribute('data-ts');
      if(ts){ var d = new Date(parseInt(ts, 10) * 1000); var tEl = el.querySelector('.time'); if(tEl){ tEl.textContent = fmtHM(d); } }
    });
  })();
</script>
{% endblock %}