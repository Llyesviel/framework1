{% extends "base.html" %}
{% block title %}Отчёты{% endblock %}
{% block page_title %}Отчёты{% endblock %}
{% block content %}
<style>
  .reports-wrap { max-width: 1000px; margin: 24px 48px; }
  .card { background:#fff; border-radius:16px; box-shadow:0 10px 20px rgba(0,0,0,0.08); padding:16px; margin-bottom:16px; }
  .card h5 { margin:0 0 8px; color:#ff8a2f; }
  .topbar-wrap { max-width: 1000px; }
</style>
<div class="reports-wrap">
  <div class="card">
    <h5>Активность по дням (создано проектов и дефектов)</h5>
    <canvas id="dailyChart" height="160"></canvas>
  </div>
  <div class="card">
    <h5>Дефекты по статусам</h5>
    <canvas id="statusChart" height="140"></canvas>
  </div>
  <div class="card">
    <h5>Дефекты по приоритетам</h5>
    <canvas id="priorityChart" height="140"></canvas>
  </div>
</div>
{{ status_labels|json_script:"status-labels" }}
{{ status_counts|json_script:"status-counts" }}
{{ priority_labels|json_script:"priority-labels" }}
{{ priority_counts|json_script:"priority-counts" }}
{{ daily_labels|json_script:"daily-labels" }}
{{ daily_projects|json_script:"daily-projects" }}
{{ daily_defects|json_script:"daily-defects" }}
<script>
const statusLabels = JSON.parse(document.getElementById('status-labels').textContent);
const statusData = JSON.parse(document.getElementById('status-counts').textContent);
const priorityLabels = JSON.parse(document.getElementById('priority-labels').textContent);
const priorityData = JSON.parse(document.getElementById('priority-counts').textContent);
const orange = '#ff8a2f';
const orangeBg = 'rgba(255,138,47,0.25)';
const orangeBgHover = 'rgba(255,138,47,0.45)';
function makeBar(ctx, labels, data){
  return new Chart(ctx, {type:'bar', data:{ labels, datasets:[{ data, backgroundColor: orangeBg, hoverBackgroundColor: orangeBgHover, borderColor: orange, borderWidth: 1 }] }, options:{ plugins:{ legend:{ display:false } }, scales:{ x:{ grid:{ color:'rgba(0,0,0,0.06)' } }, y:{ grid:{ color:'rgba(0,0,0,0.06)' }, ticks:{ precision:0 } } } } });
}
makeBar(document.getElementById('statusChart'), statusLabels, statusData);
makeBar(document.getElementById('priorityChart'), priorityLabels, priorityData);

const dailyLabels = JSON.parse(document.getElementById('daily-labels').textContent);
const dailyProjects = JSON.parse(document.getElementById('daily-projects').textContent);
const dailyDefects = JSON.parse(document.getElementById('daily-defects').textContent);
function makeLegendIcon(color){
  const c = document.createElement('canvas');
  c.width = 14; c.height = 14;
  const ctx = c.getContext('2d');
  const cx = 7, cy = 7;
  ctx.strokeStyle = color; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.arc(cx, cy, 5, 0, Math.PI*2); ctx.stroke();
  ctx.fillStyle = color;
  ctx.beginPath(); ctx.arc(cx, cy, 2, 0, Math.PI*2); ctx.fill();
  return c;
}
new Chart(document.getElementById('dailyChart'), {
  type:'line',
  data:{ labels: dailyLabels, datasets:[
    { label:'Создано проектов', data: dailyProjects, borderColor: orange, backgroundColor: 'transparent', tension: 0.2, cubicInterpolationMode:'monotone', pointRadius: 0, pointHoverRadius: 4, pointStyle: makeLegendIcon(orange), borderWidth: 2, fill:false },
    { label:'Создано дефектов', data: dailyDefects, borderColor: '#26b07d', backgroundColor: 'transparent', tension: 0.2, cubicInterpolationMode:'monotone', pointRadius: 0, pointHoverRadius: 4, pointStyle: makeLegendIcon('#26b07d'), borderWidth: 2, fill:false },
  ]},
  options:{
    plugins:{ legend:{ display:true, labels:{ usePointStyle:true, boxWidth:8 } }, tooltip:{ mode:'index', intersect:false, callbacks:{ label:function(ctx){ return ctx.dataset.label+': '+ctx.parsed.y; } } } },
    interaction:{ mode:'index', intersect:false },
    elements:{ line:{ borderWidth:2, borderCapStyle:'round', borderJoinStyle:'round' }, point:{ radius:0, hoverRadius:4 } },
    scales:{ x:{ grid:{ color:'rgba(0,0,0,0.06)' } }, y:{ beginAtZero:true, suggestedMax: Math.max(...dailyProjects, ...dailyDefects) + 1, grid:{ color:'rgba(0,0,0,0.06)' }, ticks:{ precision:0 } } }
  }
});
</script>
{% endblock %}