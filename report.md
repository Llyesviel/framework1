ёОтчёт о проекте «Defects Control»

## 1. Назначение и цели
Система централизованного управления дефектами на строительных объектах. Полный цикл работы: регистрация дефекта → назначение исполнителя → выполнение → отчёт на проверку → принятие/доработка → закрытие. Отчётность и аналитика для руководства.

- Пользователи: менеджер, инженер, наблюдатель
- Бизнес‑цели: снижение потерь информации, прозрачность статусов, быстрый контроль сроков, единая база данных и отчётность

## 2. Архитектура и стек
- Бэкенд: Python 3.13, Django 4.2 (монолит)
- Хранилище: SQLite (локально), поддержка PostgreSQL через переменные окружения
- API/инфра: Django REST Framework, django‑filters, drf‑spectacular, JWT (при необходимости)
- UI: Bootstrap 5 + кастомные CSS/JS
- Графики: Chart.js
- Экспорт: CSV/«Excel» (text/csv + BOM ‘\ufeff’, разделитель ‘;’)

Файлы:
- Конфиг: `backend/config/settings.py`
- Пользователи: `backend/users/*`
- Проекты: `backend/projects/*`
- Дефекты: `backend/defects/*`
- Отчёты: `backend/reports/*` и `backend/templates/reports/dashboard.html`

## 3. Ключевые модули и функции
### 3.1 Users/Auth
- Роли: менеджер/инженер/наблюдатель (`backend/users/models.py`)
- Профиль, смена пароля (без старого пароля для менеджера), выход
- Защита: CSRF, хеширование паролей Argon2

Примеры маршрутов:
- Профиль: `/profile/`
- Смена пароля самого пользователя: `/users/<id>/set_password/`
- Список пользователей (только менеджер): `/users/`

### 3.2 Projects
- CRUD проектов, этапы, объекты (добавление/редактирование)
- Отображение связанных дефектов в карточке проекта
- Экспорт проектов: общий и по проекту

Маршруты:
- Список: `/projects/`
- Деталь: `/projects/<id>/`
- Создать этап: `/projects/<id>/stages/create/`
- Создать объект: `/projects/<id>/objects/create/`
- Редактировать объект: `/projects/objects/<id>/edit/`
- Экспорт: `/projects/export/projects/csv|xls/`, `/projects/<id>/export/csv|xls/`

### 3.3 Defects
- CRUD дефектов, поиск, фильтрация, вложения (фото/файлы), комментарии
- Статусы: `new → in_progress → review → closed|cancelled` с проверками прав
- Инженер:
  - может принять работу (кнопка «Принять в работу»), после чего доступны комментарии, вложения, «Отправить отчёт на проверку»
  - не может редактировать поля дефекта (название/приоритет/срок/статус) — доступно менеджеру
- Менеджер:
  - назначает инженера (поиск по логину с подсказками)
  - меняет статус, редактирует данные, удаляет
- Экспорт дефектов: общий и конкретного дефекта

Маршруты:
- Список: `/defects/`
- Деталь: `/defects/<id>/`
- Принять: `POST /defects/<id>/accept/`
- Отправить отчёт: `POST /defects/<id>/submit_report/`
- Назначить инженера: `/defects/<id>/assign/` (автокомплит по логину)
- Экспорт: `/defects/export/csv|xls/` и `/defects/<id>/export/csv|xls/`

### 3.4 Reports
- Панель: графики по статусам, приоритетам, дневная активность (создано проектов/дефектов за 7 дней)
- Кастомные маркеры легенды (кольцо + точка)

Маршрут: `/reports/dashboard/`

## 4. Безопасность
- Пароли: Argon2 (`backend/config/settings.py` — `PASSWORD_HASHERS`), рекомендуется `pip install argon2-cffi`
- CSRF: включено во всех формах (`{% csrf_token %}`)
- XSS: автоэкранирование шаблонов Django
- SQL-инъекции: ORM
- Права доступа: проверки роли во вью/шаблонах (менеджер видит и может больше, инженер ограничен)

## 5. Нефункциональные требования и соответствие
- Время отклика ≤ 1 сек (50 пользователей): индексы на поля фильтрации (`Defect.status`, `Defect.priority`, `Defect.created_at`, `Project.status`), `select_related` в списках; при росте данных включить пагинацию/кэширование.
- Резервное копирование БД: команда `python manage.py backupdb` создаёт ежедневный бэкап (SQLite — копия файла, другие — JSON dump).
- Русский интерфейс: тексты и локаль `ru-RU`.
- Браузеры: Chrome/Firefox/Edge — используется Bootstrap/Chart.js/JS без нестабильных API.
- BCrypt/Argon2: включён Argon2 (возможен переход на BCrypt при необходимости).
- Защита от SQL/XSS/CSRF: обеспечена.

## 6. Тестирование (план для оценки «5»)
- Юнит‑тесты (≥5):
  - Проверка переходов статусов (валидные/невалидные)
  - Ограничения прав инженера/менеджера
  - Назначение инженера (валидный/невалидный логин)
  - Экспорт функций (корректная кодировка/разделитель)
  - Отчёты (корректные данные за 7 дней)
- Интеграционные сценарии (≥2):
  1) Менеджер назначает инженера → инженер принимает работу → добавляет отчёт → менеджер переводит в «На проверке/Закрыт»
  2) Создание проекта → добавление этапа/объекта → создание дефекта → проверка отображения в карточке проекта
- Нагрузочное: имитация 50 параллельных пользователей, замер TTFB/отклика; цель ≤ 1 сек. Инструменты: Locust/JMeter.
- Регрессия: прогон ключевых сценариев после обновлений.

## 7. Развёртывание и резервное копирование
### 7.1 Локальный запуск
```bash
python manage.py runserver
```
Переключение на SQLite для dev: переменные `DJANGO_USE_SQLITE=1`, `DJANGO_SQLITE_NAME=db-dev.sqlite3`.

### 7.2 Ежедневный бэкап
- Windows Task Scheduler:
  - Действие: `python manage.py backupdb`
  - Частота: ежедневно (например, 02:00)
  - Каталог: `backend/backups/` (создаётся автоматически)
- Docker/cron: добавить `0 2 * * * python manage.py backupdb` в джоб/контейнер

## 8. Примеры пользовательских сценариев
### 8.1 Менеджер назначает инженера
1. Открыть дефект `/defects/<id>/`
2. Нажать «Назначить инженера» → ввести логин → выбрать из подсказок → «Сохранить»
3. Статус остаётся `new`, исполнитель установлен.

### 8.2 Инженер принимает и отправляет отчёт
1. Открыть назначенный дефект `/defects/<id>/`
2. Нажать «Принять в работу» → статус `in_progress` → становятся доступны «Вложения» и «Отправить отчёт»
3. Заполнить комментарий/приложить фото → «Отправить отчёт на проверку» → статус `review`

### 8.3 Отчёты и экспорт
- Панель `/reports/dashboard/`: посмотреть активности/статистики
- Экспорт дефектов: `/defects/export/csv|xls/` или конкретного дефекта `/defects/<id>/export/csv|xls/`
- Экспорт проектов: общий `/projects/export/projects/csv|xls/`, по проекту `/projects/<id>/export/csv|xls/`

## 9. Скриншоты: что и как снять
1. Список проектов `/projects/`: верхний хедер, кнопки экспорта, карточки
2. Карточка проекта `/projects/<id>/`: таблицы этапов/объектов/дефектов
3. Список дефектов `/defects/`: поиск, всплывающие «Статус/Приоритет», экспорт справа
4. Карточка дефекта `/defects/<id>/`: блок действий, таблица информации, «Принять/Принят», комментарии, вложения
5. Отчёты `/reports/dashboard/`: бар‑графики и дневная линия с кастомной легендой
6. Профиль `/profile/`: русская локаль, оранжево‑серый стиль, смена пароля (персональный маршрут)

Советы:
- Откройте страницу, нажмите `Ctrl+F5` перед скрином
- Используйте 1366×768 или 1920×1080 для единообразия
- Захватывайте всю карточку/график целиком, без лишнего фона

## 10. Соответствие оценке «5»
- Реализация модулей: Users/Projects/Defects/Reports, вложения, фильтры, экспорт
- Безопасность: роли, CSRF, ORM, Argon2, резервное копирование
- UX: русский язык, адаптивность, оранжево‑серый стиль, однотипные элементы
- Для полного закрытия «5»: подготовить формальный план тестирования, юнит/интеграционные тесты и результаты нагрузочного прогона, плюс документация деплоя/мониторинга.